<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Live coding, Emacs, and ghci</title>
    <link rel="stylesheet" href="https://robmoss.github.io/css/base.css"/>
    <link rel="stylesheet" href="https://robmoss.github.io/css/syntax-theme.css"/>
    
  </head>
<body><header class="site">
  <nav>
    <ul><li><a title="Home" class="inactive" href="https://robmoss.github.io/"><picture>
            <source srcset="https://robmoss.github.io/images/home.png" media="(prefers-color-scheme: light)"/>
            <source srcset="https://robmoss.github.io/images/dark_home.png" media="(prefers-color-scheme: dark)"/>
            <img alt="Home" src="https://robmoss.github.io/images/home.png"/>
      </picture></a></li><li><a title="Research" class="inactive" href="https://robmoss.github.io/research/"><picture>
            <source srcset="https://robmoss.github.io/images/influenza.png" media="(prefers-color-scheme: light)"/>
            <source srcset="https://robmoss.github.io/images/dark_influenza.png" media="(prefers-color-scheme: dark)"/>
            <img alt="Research" src="https://robmoss.github.io/images/influenza.png"/>
      </picture></a></li><li><a title="Teaching" class="inactive" href="https://robmoss.github.io/teaching/"><picture>
            <source srcset="https://robmoss.github.io/images/teaching.png" media="(prefers-color-scheme: light)"/>
            <source srcset="https://robmoss.github.io/images/dark_teaching.png" media="(prefers-color-scheme: dark)"/>
            <img alt="Teaching" src="https://robmoss.github.io/images/teaching.png"/>
      </picture></a></li><li><a title="Models" class="inactive" href="https://robmoss.github.io/models/"><picture>
            <source srcset="https://robmoss.github.io/images/model.png" media="(prefers-color-scheme: light)"/>
            <source srcset="https://robmoss.github.io/images/dark_model.png" media="(prefers-color-scheme: dark)"/>
            <img alt="Models" src="https://robmoss.github.io/images/model.png"/>
      </picture></a></li><li><a title="Blog" class="inactive" href="https://robmoss.github.io/blog/"><picture>
            <source srcset="https://robmoss.github.io/images/info.png" media="(prefers-color-scheme: light)"/>
            <source srcset="https://robmoss.github.io/images/dark_info.png" media="(prefers-color-scheme: dark)"/>
            <img alt="Blog" src="https://robmoss.github.io/images/info.png"/>
      </picture></a></li></ul>
  </nav>
</header>

  <article class="post">
    
<header>
  <h1>Live coding, Emacs, and ghci</h1>
  
    <span class="post meta date">19 Feb 2018</span>
  
  
    —
  
  
    
      <a class="tag" href="https://robmoss.github.io/tag/tutorial/">tutorial</a>
    
  
</header>

    <p>This semester I'm co-lecturing Declarative Programming (COMP90048). The topics I'll be covering include monads, laziness, performance, and type system expressiveness, with <a href="https://www.haskell.org/">Haskell</a> as our language of choice. This will be the first time that I'll try live coding in front of students, because I've previously lectured non-programming subjects such as multi-variable calculus and infectious disease modelling.</p>
<p>The obvious choice of tool for live demonstrations of Haskell code and expression evaluation is <code>ghci</code>. And I happen to have <code>ghci</code> already installed, by virtue of using <a href="http://xmonad.org/">xmonad</a> to manage my windows and workspaces. I also spend most of my working hours living in <a href="https://www.gnu.org/software/emacs/">Emacs</a>, which has great support for working with interactive programming environments (also referred to as REPLs, Read-Eval-Print Loops) and for taking code blocks from open files and evaluating them in these environments. So I know what my preferred tools are. But it wasn't immediately clear to me what the precise <em>workflow</em> should be.</p>
<span id="continue-reading"></span><h1 id="the-problem">The problem</h1>
<p>First things first, I installed <a href="https://github.com/haskell/haskell-mode">haskell-mode</a>. Since I'm currently testing out <a href="http://spacemacs.org/">Spacemacs</a> (a nice veneer of pre-configured packages for Emacs) this was as easy as opening a file with a <code>.hs</code> extension and responding &quot;yes&quot; to the haskell-mode installation prompt (see the <a href="https://haskell.github.io/haskell-mode/manual/latest/">manual</a> if you don't use Spacemacs). This meant I could now open Haskell files, load them in interactive <code>ghci</code> buffers, and use the defined functions and types for live coding. For example, with the following content in <code>Test.hs</code>:</p>
<pre data-lang="haskell" class="language-haskell z-code"><code class="language-haskell" data-lang="haskell"><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell"><span class="z-entity z-name z-function z-haskell">f</span> <span class="z-keyword z-other z-double-colon z-haskell">::</span> <span class="z-storage z-type z-haskell">Num</span> <span class="z-variable z-other z-generic-type z-haskell">a</span> <span class="z-keyword z-other z-big-arrow z-haskell">=&gt;</span> <span class="z-variable z-other z-generic-type z-haskell">a</span> <span class="z-keyword z-other z-arrow z-haskell">-&gt;</span> <span class="z-variable z-other z-generic-type z-haskell">a</span> <span class="z-keyword z-other z-arrow z-haskell">-&gt;</span> <span class="z-variable z-other z-generic-type z-haskell">a</span>
</span>f x y <span class="z-keyword z-operator z-haskell">=</span> x^<span class="z-constant z-numeric z-integer z-decimal z-haskell">2</span> <span class="z-keyword z-operator z-haskell">+</span> y^<span class="z-constant z-numeric z-integer z-decimal z-haskell">2</span>
</span></code></pre>
<p>I could open this file in Emacs and use <code>haskell-process-load-file</code> (<strong>C-c C-l</strong> or <strong>SPC m s b</strong>) to launch a new <code>ghci</code> session and load this definition:</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">λ&gt; f 3 4
25
λ&gt;
</span></code></pre>
<p>But I'm picky; this isn't enough. I don't want to manage lots of individual files that each contain a handful of definitions. I'd rather organise all of these examples in a single <a href="https://orgmode.org/">Org mode</a> document. Org mode allows you to embed blocks of code in a simple manner:</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">#+BEGIN_SRC haskell
f :: Num a =&gt; a -&gt; a -&gt; a
f x y = x^2 + y^2
#+END_SRC
</span></code></pre>
<p>When the cursor is inside one of these source code blocks, you can use <code>org-edit-src-code</code> (<strong>C-c '</strong> or <strong>SPC m '</strong>) to open a transient buffer that contains only the contents of that block, with all of the language-specific bells and whistles at your disposal. So my first thought was to use <code>haskell-process-load-file</code> from within one of these buffers. It didn't work:</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">Unexpected response from haskell process.
</span></code></pre>
<h1 id="looking-for-a-solution">Looking for a solution</h1>
<p>But this is Emacs. <em>I can dig into these commands and see what's going wrong</em>. So <strong>C-h f</strong> <code>haskell-process-load-file</code> tells me that this function accepts no arguments and loads the current buffer file. But I can also inspect the code for this function (<em>click on link</em>) and I can immediately see that it's loading the buffer contents from an external file (as returned by <code>buffer-file-name</code> on line 9):</p>
<pre data-linenos data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><table><tbody><tr><td>1</td><td><span class="z-source z-emacs-lisp"><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-function z-lisp"><span class="z-keyword z-declaration z-function z-lisp">defun</span> <span class="z-entity z-name z-function z-lisp">haskell-process-load-file</span></span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>2</td><td>  <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>Load the current buffer file.<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>3</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">interactive</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>4</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">save-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>5</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-interactive-mode-reset-error</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-session</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>6</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-process-file-loadish</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">format</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>load <span class="z-constant z-character z-escape z-lisp">\&quot;</span>%s<span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">replace</span><span class="z-symbol z-language z-lisp">-regexp-in-string</span>
</td></tr><tr><td>7</td><td>                                                       <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span><span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>8</td><td>                                                       <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span><span class="z-constant z-character z-escape z-lisp">\\</span><span class="z-constant z-character z-escape z-lisp">\\</span><span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>9</td><td>                                                       <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buffer-file-name</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>10</td><td>                                <span class="z-constant z-language z-lisp">nil</span>
</td></tr><tr><td>11</td><td>                                <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">current-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr></span></tbody></table></code></pre>
<p>Presumably the transient buffer isn't associated with a file name, and so <code>(buffer-file-name)</code> will return <code>nil</code>, meaning that <code>ghci</code> is unable to load this non-existent file. <em>Spoiler:</em> I later realised that the transient buffer is actually associated with the Org mode document from whence it came, and so <code>ghci</code> will attempt to compile and load the Org mode document as a Haskell source file. Either way, <code>ghci</code> is trying to load something that <em>isn't</em> a valid Haskell source file.</p>
<p>It was relatively simple to write a modified version of <code>haskell-process-load-file</code> that saves the buffer to a temporary file, using <code>org-babel-temp-file</code> to generate the filename.</p>
<pre data-linenos data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><table><tbody><tr><td>1</td><td><span class="z-source z-emacs-lisp"><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-function z-lisp"><span class="z-keyword z-declaration z-function z-lisp">defun</span> <span class="z-entity z-name z-function z-lisp">haskell-process-load-buffer</span></span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>2</td><td>  <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>Load the current buffer via a temporary file.<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>3</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">interactive</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>4</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buffer</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">current-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>5</td><td>        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">body</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buffer-string</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>6</td><td>        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tmp-file</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">concat</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">org-babel-temp-file</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>haskell-load-<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>.hs<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>7</td><td>    <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">with</span><span class="z-symbol z-language z-lisp">-temp-buffer</span>
</td></tr><tr><td>8</td><td>      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">insert</span> <span class="z-symbol z-language z-lisp">body</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>9</td><td>      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">write</span><span class="z-symbol z-language z-lisp">-file</span> <span class="z-symbol z-language z-lisp">tmp-file</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>10</td><td>      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-interactive-mode-reset-error</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-session</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>11</td><td>      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-process-file-loadish</span>
</td></tr><tr><td>12</td><td>       <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">format</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>load <span class="z-constant z-character z-escape z-lisp">\&quot;</span>%s<span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">replace</span><span class="z-symbol z-language z-lisp">-regexp-in-string</span>
</td></tr><tr><td>13</td><td>                              <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span><span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>14</td><td>                              <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span><span class="z-constant z-character z-escape z-lisp">\\</span><span class="z-constant z-character z-escape z-lisp">\\</span><span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>15</td><td>                              <span class="z-symbol z-language z-lisp">tmp-file</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>16</td><td>       <span class="z-constant z-language z-lisp">nil</span>
</td></tr><tr><td>17</td><td>       <span class="z-symbol z-language z-lisp">buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr></span></tbody></table></code></pre>
<p>I'd rather not duplicate some of the internals of <code>haskell-process-load-file</code>, but calling <code>haskell-process-load-file</code> from within the <code>with-temp-buffer</code> block produces the following error message:</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">Haskell process command errored with: (error &quot;Selecting deleted buffer&quot;)
</span></code></pre>
<p>This occurs because the temporary buffer created by <code>with-temp-buffer</code> will cease to exist once control exits that scope. It's not critical — the code is still loaded successfully — but I'd rather not have error messages appear unless they're <em>meaningful</em>. This can be avoided by manually calling <code>haskell-process-file-loadish</code> and passing it a reference to the original code buffer.</p>
<h1 id="refining-the-solution">Refining the solution</h1>
<p>Calling <code>haskell-process-load-buffer</code> from within transient code buffers now works as expected. But it's tedious having to use a different command when working in a transient buffer — it would be ideal to replace all of the key bindings for <code>haskell-process-load-file</code> to call this function instead. A much simpler approach (and less error-prone than searching through all of the different keymaps to identify the appropriate key bindings) is to use Emacs' <em>advice system</em>, which allows you to <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Advising-Functions.html">modify</a> an existing function.</p>
<pre data-linenos data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><table><tbody><tr><td>1</td><td><span class="z-source z-emacs-lisp"><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-function z-lisp"><span class="z-keyword z-declaration z-function z-lisp">defun</span> <span class="z-entity z-name z-function z-lisp">haskell-process-load-buffer</span></span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">orig-fun</span> &amp;<span class="z-support z-function z-lisp">rest</span> <span class="z-symbol z-language z-lisp">args</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>2</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">if</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">and</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buffer-file-name</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">not</span> <span class="z-symbol z-language z-lisp">org-src-mode</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>3</td><td>      <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; The buffer is associated with a file, and is not a transient Org mode
</span></td></tr><tr><td>4</td><td>      <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; code buffer, so the file *should* only contain Haskell code.
</span></td></tr><tr><td>5</td><td>      <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; In which case, call the original function.
</span></td></tr><tr><td>6</td><td>      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">apply</span> <span class="z-symbol z-language z-lisp">orig-fun</span> <span class="z-symbol z-language z-lisp">args</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>7</td><td>    <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; The alternative is that the buffer is not associated with a Haskell
</span></td></tr><tr><td>8</td><td>    <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; file and its contents should be saved to a temporary file.
</span></td></tr><tr><td>9</td><td>    <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span><span class="z-keyword z-operator z-arithmetic z-lisp">*</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buffer</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">current-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>10</td><td>           <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">body</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buffer-string</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>11</td><td>           <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tmp-prefix</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>haskell-load-<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>12</td><td>           <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tmp-suffix</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>.hs<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>13</td><td>           <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tmp-file</span>
</td></tr><tr><td>14</td><td>            <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">if</span> <span class="z-symbol z-language z-lisp">org-src-mode</span>
</td></tr><tr><td>15</td><td>                <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Org Babel has its own temp-file functions.
</span></td></tr><tr><td>16</td><td>                <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">concat</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">org-babel-temp-file</span> <span class="z-symbol z-language z-lisp">tmp-prefix</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span> <span class="z-symbol z-language z-lisp">tmp-suffix</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>17</td><td>              <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Create a normal Emacs temporary file.
</span></td></tr><tr><td>18</td><td>              <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">make-temp-file</span> <span class="z-symbol z-language z-lisp">tmp-prefix</span> <span class="z-constant z-language z-lisp">nil</span> <span class="z-symbol z-language z-lisp">tmp-suffix</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>19</td><td>      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">with</span><span class="z-symbol z-language z-lisp">-temp-buffer</span>
</td></tr><tr><td>20</td><td>        <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Copy the contents of the original buffer into this temporary buffer
</span></td></tr><tr><td>21</td><td>        <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; and save it to the newly-created temporary file.
</span></td></tr><tr><td>22</td><td>        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">insert</span> <span class="z-symbol z-language z-lisp">body</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>23</td><td>        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">write</span><span class="z-symbol z-language z-lisp">-file</span> <span class="z-symbol z-language z-lisp">tmp-file</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>24</td><td>        <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Instruct ghci to load this file, as per haskell-process-load-file.
</span></td></tr><tr><td>25</td><td>        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-interactive-mode-reset-error</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-session</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>26</td><td>        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-process-file-loadish</span>
</td></tr><tr><td>27</td><td>         <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">format</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>load <span class="z-constant z-character z-escape z-lisp">\&quot;</span>%s<span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">replace</span><span class="z-symbol z-language z-lisp">-regexp-in-string</span>
</td></tr><tr><td>28</td><td>                                <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span><span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>29</td><td>                                <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span><span class="z-constant z-character z-escape z-lisp">\\</span><span class="z-constant z-character z-escape z-lisp">\\</span><span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>30</td><td>                                <span class="z-symbol z-language z-lisp">tmp-file</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>31</td><td>         <span class="z-constant z-language z-lisp">nil</span>
</td></tr><tr><td>32</td><td>         <span class="z-symbol z-language z-lisp">buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>33</td><td>
</td></tr><tr><td>34</td><td><span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Install a wrapper around the existing haskell-process-load-file function.
</span></td></tr><tr><td>35</td><td><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">advice-add</span> &#39;<span class="z-symbol z-language z-lisp">haskell-process-load-file</span> :<span class="z-symbol z-language z-lisp">around</span>
</td></tr><tr><td>36</td><td>            <span class="z-constant z-character z-lisp"><span class="z-punctuation z-definition z-constant z-lisp">#</span>&#39;haskell-process-load-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr></span></tbody></table></code></pre>
<p>Another approach would be to call <code>haskell-process-load-file</code> within a <code>with-temp-buffer</code> block, perhaps that's simpler? Then the check would be <code>(if (buffer-file-name) (orig-fun) (...))</code>. <em>But</em> that's when I discovered that this temporary code buffer is associated with the <code>.org</code> file in which it is contained.</p>
<h1 id="multiple-code-blocks-and-tangling">Multiple code blocks and tangling</h1>
<p>Org mode allows you to extract source code from multiple code blocks and &quot;<a href="https://orgmode.org/manual/Extracting-source-code.html">tangle</a>&quot; them together to produce a source code file. And for each code block, you can define the file into which it should be tangled by using the <code>:tangle</code> header argument. When the argument is <code>:tangle yes</code>, the output file will be the same as the Org file, but with an appropriate extension (&quot;.hs&quot; in this case); you can also use <code>:tangle path/to/file.hs</code> to write the code block(s) to a specific file. In the example below the two code blocks will be tangled together to produce <code>Test1.hs</code>, which will contain the definitions of both <code>f</code> and <code>g</code>:</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">#+BEGIN_SRC haskell :tangle TestTangle.hs
  f x y = x + y
#+END_SRC

#+BEGIN_SRC haskell :tangle TestTangle.hs
  g x = f x x
#+END_SRC
</span></code></pre>
<p>This would appear as two code blocks (shown below) and they could be placed anywhere in the document — they don't need to be adjacent.</p>
<pre data-lang="haskell" class="language-haskell z-code"><code class="language-haskell" data-lang="haskell"><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell"><span class="z-entity z-name z-function z-haskell">f</span> <span class="z-keyword z-other z-double-colon z-haskell">::</span> <span class="z-storage z-type z-haskell">Num</span> <span class="z-variable z-other z-generic-type z-haskell">a</span> <span class="z-keyword z-other z-big-arrow z-haskell">=&gt;</span> <span class="z-variable z-other z-generic-type z-haskell">a</span> <span class="z-keyword z-other z-arrow z-haskell">-&gt;</span> <span class="z-variable z-other z-generic-type z-haskell">a</span> <span class="z-keyword z-other z-arrow z-haskell">-&gt;</span> <span class="z-variable z-other z-generic-type z-haskell">a</span>
</span>f x y <span class="z-keyword z-operator z-haskell">=</span> x <span class="z-keyword z-operator z-haskell">+</span> y
</span></code></pre>
<p>For example, this text will not be included in <code>TestTangle.hs</code> when the two blocks (above and below) are tangled together.</p>
<pre data-lang="haskell" class="language-haskell z-code"><code class="language-haskell" data-lang="haskell"><span class="z-source z-haskell"><span class="z-meta z-function z-type-declaration z-haskell"><span class="z-entity z-name z-function z-haskell">g</span> <span class="z-keyword z-other z-double-colon z-haskell">::</span> <span class="z-storage z-type z-haskell">Num</span> <span class="z-variable z-other z-generic-type z-haskell">a</span> <span class="z-keyword z-other z-big-arrow z-haskell">=&gt;</span> <span class="z-variable z-other z-generic-type z-haskell">a</span> <span class="z-keyword z-other z-arrow z-haskell">-&gt;</span> <span class="z-variable z-other z-generic-type z-haskell">a</span>
</span>g x <span class="z-keyword z-operator z-haskell">=</span> f x x
</span></code></pre>
<h2 id="why-tangle-code-blocks">Why tangle code blocks</h2>
<p>Why tangle these blocks, rather than simply concatenating their contents? Because Org mode supports features such as <a href="https://orgmode.org/manual/Specific-header-arguments.html">passing variables and results</a> between blocks, and <a href="https://orgmode.org/manual/Noweb-reference-syntax.html">referring to other code blocks</a>, and so exporting the source code is more complex than simply extracting the code verbatim from within each code block.</p>
<p>So when working in a transient code buffer, all of the relevant code blocks should be tangled together. If the code block shouldn't be tangled (the default, which can also be achieved with <code>:tangle no</code>) then it's probably sensible to tangle just the single block.</p>
<h2 id="how-to-tangle-code-blocks">How to tangle code blocks</h2>
<p>You can discover how to tangle code blocks by looking at the documentation for <code>org-babel-tangle</code>, using <strong>M-x describe-function</strong> (<strong>C-h f</strong>).</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">(org-babel-tangle &amp;optional ARG TARGET-FILE LANG)

Write code blocks to source-specific files.
Extract the bodies of all source code blocks from the current
file into their own source-specific files.
With one universal prefix argument, only tangle the block at point.
When two universal prefix arguments, only tangle blocks for the
tangle file of the block at point.
Optional argument TARGET-FILE can be used to specify a default
export file for all source blocks.  Optional argument LANG can be
used to limit the exported source code blocks by language.
</span></code></pre>
<p>If you're not familiar with the <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Prefix-Command-Arguments.html">universal prefix argument</a> (<strong>C-u</strong>), the salient point is that when <code>ARG</code> is set to <code>(4)</code> only the code block at the point (i.e., the cursor's current position) will be tangled, and when <code>ARG</code> is set to <code>(16)</code> only code blocks for the tangle file of the code block at the point will be tangled.</p>
<p>So if the code block should be tangled (<code>:tangle yes</code> or <code>:tangle file.hs</code>) this can be achieved with <code>(org-babel-tangle '(16))</code>, and if the code block shouldn't be tangled it should be written to a temporary file and tangled with <code>(org-babel-tangle '(4) temp-file)</code>.</p>
<p>Finally, when working in an Org buffer you can inspect the code block at the point with <code>(org-babel-get-src-block-info t)</code> (the argument <code>t</code> prevents Org from resolving remote variable references, which could require executing other code blocks). When working in a transient code buffer, these details are stored in the variable <code>org-src--babel-info</code> and the parent Org buffer is stored in the variable <code>org-src--source-buffer</code>; these details can be discovered by using <strong>M-x describe-variable</strong> (<strong>C-h v</strong>).</p>
<h1 id="putting-it-all-together">Putting it all together</h1>
<p>So the following situations need to be covered when dealing with Org mode source blocks:</p>
<ul>
<li>The current buffer is a transient buffer that is being used to edit the contents of a code block in an Org mode file.</li>
<li>The current buffer is an Org mode file and the cursor is a source code block.</li>
</ul>
<p>In either case, the relevant source code blocks should be tangled, and the resulting code loaded from the tangled file.</p>
<p>It might also be useful to tangle <em>only</em> the current code block, even if there are other code blocks that should be tangled into the same file, so that the contents of that code block can be interrogated in isolation. A simple way to <a href="https://www.emacswiki.org/emacs/PrefixArgument">overload a command's behaviour</a> is to make use of the universal prefix argument (i.e., the approach used by <code>org-babel-tangle</code> and many, many other Emacs commands), allowing the user to select either behaviour; see lines 62–65.</p>
<pre data-linenos data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><table><tbody><tr><td>1</td><td><span class="z-source z-emacs-lisp"><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-function z-lisp"><span class="z-keyword z-declaration z-function z-lisp">defun</span> <span class="z-entity z-name z-function z-lisp">send-to-haskell</span></span><span class="z-keyword z-operator z-arithmetic z-lisp">/</span><span class="z-symbol z-language z-lisp">file-with-buffer</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">file-name</span> <span class="z-symbol z-language z-lisp">buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>2</td><td>  <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>Load FILE-NAME in a REPL session and associate it with BUFFER.<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>3</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-interactive-mode-reset-error</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-session</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>4</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">haskell-process-file-loadish</span>
</td></tr><tr><td>5</td><td>   <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">format</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>load <span class="z-constant z-character z-escape z-lisp">\&quot;</span>%s<span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">replace</span><span class="z-symbol z-language z-lisp">-regexp-in-string</span>
</td></tr><tr><td>6</td><td>                          <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span><span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>7</td><td>                          <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span><span class="z-constant z-character z-escape z-lisp">\\</span><span class="z-constant z-character z-escape z-lisp">\\</span><span class="z-constant z-character z-escape z-lisp">\&quot;</span><span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>8</td><td>                          <span class="z-symbol z-language z-lisp">file-name</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>9</td><td>   <span class="z-constant z-language z-lisp">nil</span>
</td></tr><tr><td>10</td><td>   <span class="z-symbol z-language z-lisp">buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>11</td><td>
</td></tr><tr><td>12</td><td><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-function z-lisp"><span class="z-keyword z-declaration z-function z-lisp">defun</span> <span class="z-entity z-name z-function z-lisp">send-to-haskell</span></span><span class="z-keyword z-operator z-arithmetic z-lisp">/</span><span class="z-symbol z-language z-lisp">org-src-block</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span>&amp;<span class="z-symbol z-language z-lisp">optional</span> <span class="z-symbol z-language z-lisp">arg</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>13</td><td>  <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>Tangle the current Org mode source block and load it in a REPL session.
</td></tr><tr><td>14</td><td>With one universal prefix argument, only tangle the block at point.<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>15</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">interactive</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>P<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>16</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span><span class="z-keyword z-operator z-arithmetic z-lisp">*</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">src-block</span>
</td></tr><tr><td>17</td><td>          <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">cond</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">string</span><span class="z-keyword z-operator z-comparison z-lisp">=</span> <span class="z-symbol z-language z-lisp">major-mode</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>org-mode<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>18</td><td>                 <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; In an Org mode buffer, is the cursor in a source block?
</span></td></tr><tr><td>19</td><td>                 <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">info</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">org-babel-get-src-block-info</span> <span class="z-constant z-language z-lisp">t</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>20</td><td>                   <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">if</span> <span class="z-symbol z-language z-lisp">info</span>
</td></tr><tr><td>21</td><td>                       <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">list</span> <span class="z-symbol z-language z-lisp">info</span> <span class="z-constant z-language z-lisp">nil</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">current-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>22</td><td>                     <span class="z-constant z-language z-lisp">nil</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>23</td><td>                <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">org-src-mode</span>
</td></tr><tr><td>24</td><td>                 <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; In a transient source code buffer.
</span></td></tr><tr><td>25</td><td>                 <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">list</span> <span class="z-symbol z-language z-lisp">org-src--babel-info</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">current-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>26</td><td>                       <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">org-src--source-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>27</td><td>                <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-constant z-language z-lisp">t</span>
</td></tr><tr><td>28</td><td>                 <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Not in an Org mode source block or transient code buffer.
</span></td></tr><tr><td>29</td><td>                 <span class="z-constant z-language z-lisp">nil</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>30</td><td>         <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">is-haskell-src</span>
</td></tr><tr><td>31</td><td>          <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">and</span> <span class="z-symbol z-language z-lisp">src-block</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">string</span><span class="z-keyword z-operator z-comparison z-lisp">=</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>haskell<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">0</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">0</span> <span class="z-symbol z-language z-lisp">src-block</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>32</td><td>    <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">unless</span> <span class="z-symbol z-language z-lisp">is-haskell-src</span>
</td></tr><tr><td>33</td><td>      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">user-error</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>Not in a Haskell source code block<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>34</td><td>    <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">when</span> <span class="z-symbol z-language z-lisp">is-haskell-src</span>
</td></tr><tr><td>35</td><td>      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span><span class="z-keyword z-operator z-arithmetic z-lisp">*</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">info</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">0</span> <span class="z-symbol z-language z-lisp">src-block</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>36</td><td>             <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">code-buffer</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">1</span> <span class="z-symbol z-language z-lisp">src-block</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>37</td><td>             <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">org-buffer</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">2</span> <span class="z-symbol z-language z-lisp">src-block</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>38</td><td>             <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">lang</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">0</span> <span class="z-symbol z-language z-lisp">info</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>39</td><td>             <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">contents</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">1</span> <span class="z-symbol z-language z-lisp">info</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>40</td><td>             <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">params</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">2</span> <span class="z-symbol z-language z-lisp">info</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>41</td><td>             <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tangle-to</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">cdr</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">assq</span> :<span class="z-symbol z-language z-lisp">tangle</span> <span class="z-symbol z-language z-lisp">params</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>42</td><td>             <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">posn</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">5</span> <span class="z-symbol z-language z-lisp">info</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>43</td><td>        <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Tangle the relevant code block(s) and get the tangled file name.
</span></td></tr><tr><td>44</td><td>        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">out-file</span>
</td></tr><tr><td>45</td><td>               <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">cond</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">string</span><span class="z-keyword z-operator z-comparison z-lisp">=</span> <span class="z-symbol z-language z-lisp">tangle-to</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>no<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>46</td><td>                      <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Tangle this *single block* to a temporary file
</span></td></tr><tr><td>47</td><td>                      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span><span class="z-keyword z-operator z-arithmetic z-lisp">*</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tmp-prefix</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>haskell-load-<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>48</td><td>                             <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tmp-suffix</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>.hs<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>49</td><td>                             <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tmp-file</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">concat</span>
</td></tr><tr><td>50</td><td>                                        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">org-babel-temp-file</span> <span class="z-symbol z-language z-lisp">tmp-prefix</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>51</td><td>                                        <span class="z-symbol z-language z-lisp">tmp-suffix</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>52</td><td>                        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">with</span><span class="z-symbol z-language z-lisp">-current-buffer</span> <span class="z-symbol z-language z-lisp">org-buffer</span>
</td></tr><tr><td>53</td><td>                          <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">goto-char</span> <span class="z-symbol z-language z-lisp">posn</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>54</td><td>                          <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tangled-files</span>
</td></tr><tr><td>55</td><td>                                 <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">org-babel-tangle</span> &#39;<span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-constant z-numeric z-lisp">4</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span> <span class="z-symbol z-language z-lisp">tmp-file</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>56</td><td>                            <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">message</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>Tangled: %s<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-symbol z-language z-lisp">tangled-files</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>57</td><td>                            <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">0</span> <span class="z-symbol z-language z-lisp">tangled-files</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>58</td><td>                     <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-constant z-language z-lisp">t</span>
</td></tr><tr><td>59</td><td>                      <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Tangle all relevant blocks to a specified file
</span></td></tr><tr><td>60</td><td>                      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">with</span><span class="z-symbol z-language z-lisp">-current-buffer</span> <span class="z-symbol z-language z-lisp">org-buffer</span>
</td></tr><tr><td>61</td><td>                        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">goto-char</span> <span class="z-symbol z-language z-lisp">posn</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td><mark>62</mark></td><td><mark>                        <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; If `arg&#39; is &#39;(4), only tangle this single block.
</span></mark></td></tr><tr><td><mark>63</mark></td><td><mark>                        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span><span class="z-keyword z-operator z-arithmetic z-lisp">*</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">arg</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">if</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">equal</span> <span class="z-symbol z-language z-lisp">arg</span> &#39;<span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-constant z-numeric z-lisp">4</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span> &#39;<span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-constant z-numeric z-lisp">4</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span> &#39;<span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-constant z-numeric z-lisp">16</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</mark></td></tr><tr><td><mark>64</mark></td><td><mark>                               <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tangled-files</span>
</mark></td></tr><tr><td><mark>65</mark></td><td><mark>                                <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">org-babel-tangle</span> <span class="z-symbol z-language z-lisp">arg</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>haskell<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</mark></td></tr><tr><td>66</td><td>                          <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">message</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>Tangled: %s<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-symbol z-language z-lisp">tangled-files</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>67</td><td>                          <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">nth</span> <span class="z-constant z-numeric z-lisp">0</span> <span class="z-symbol z-language z-lisp">tangled-files</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>68</td><td>          <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Now visit this tangled file and load it in ghci.
</span></td></tr><tr><td>69</td><td>          <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">if</span> <span class="z-symbol z-language z-lisp">code-buffer</span>
</td></tr><tr><td>70</td><td>              <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; There is an existing code buffer, use a temporary buffer to
</span></td></tr><tr><td>71</td><td>              <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; visit the tangled file.
</span></td></tr><tr><td>72</td><td>              <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">with</span><span class="z-symbol z-language z-lisp">-temp-buffer</span>
</td></tr><tr><td>73</td><td>                <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">insert-file-contents</span> <span class="z-symbol z-language z-lisp">out-file</span> <span class="z-constant z-language z-lisp">t</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>74</td><td>                <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">send-to-haskell</span><span class="z-keyword z-operator z-arithmetic z-lisp">/</span><span class="z-symbol z-language z-lisp">file-with-buffer</span> <span class="z-symbol z-language z-lisp">out-file</span> <span class="z-symbol z-language z-lisp">code-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>75</td><td>            <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; No existing code buffer, visit the file normally.
</span></td></tr><tr><td>76</td><td>            <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Set `NOWARN&#39; to `t&#39; to avoid prompting the user to reread the
</span></td></tr><tr><td>77</td><td>            <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; file if the contents (on disk) have changed.
</span></td></tr><tr><td>78</td><td>            <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tangled-buffer</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">find</span><span class="z-symbol z-language z-lisp">-file-noselect</span> <span class="z-symbol z-language z-lisp">out-file</span> <span class="z-constant z-language z-lisp">t</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>79</td><td>              <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">with</span><span class="z-symbol z-language z-lisp">-current-buffer</span> <span class="z-symbol z-language z-lisp">tangled-buffer</span>
</td></tr><tr><td>80</td><td>                <span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Ensure the buffer name starts and ends with an asterisk.
</span></td></tr><tr><td>81</td><td>                <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buf-name</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buffer-name</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>82</td><td>                  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">unless</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">and</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">string</span><span class="z-symbol z-language z-lisp">-prefix-p</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>*<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-symbol z-language z-lisp">buf-name</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>83</td><td>                               <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">string</span><span class="z-symbol z-language z-lisp">-suffix-p</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>*<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-symbol z-language z-lisp">buf-name</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>84</td><td>                    <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">rename-buffer</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">concat</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>*<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-symbol z-language z-lisp">buf-name</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>*<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>85</td><td>                <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">send-to-haskell</span><span class="z-keyword z-operator z-arithmetic z-lisp">/</span><span class="z-symbol z-language z-lisp">file-with-buffer</span> <span class="z-symbol z-language z-lisp">out-file</span> <span class="z-symbol z-language z-lisp">tangled-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>86</td><td>          <span class="z-constant z-language z-lisp">nil</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr></span></tbody></table></code></pre>
<p>More generally, the following cases should also be handled:</p>
<ul>
<li>The current buffer is not associated with a file and only contains Haskell code, in which case its contents should be saved to a temporary file, from which the code can then be loaded.</li>
<li>The current buffer is associated with a Haskell source file, in which case <code>haskell-process-load-file</code> can be used as-is.</li>
</ul>
<p>Again, Emacs' advice system can be used to wrap <code>haskell-process-load-file</code> and handle each of these cases. Note that the order of the clauses in following the <code>cond</code> statement is important, because <code>org-src-mode</code> buffers are associated with a non-Haskell file (i.e., their parent Org document), and that the value of the prefix argument (<code>current-prefix-arg</code>) is explicitly provided as an argument to <code>send-to-haskell/org-src-block</code>.</p>
<pre data-linenos data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><table><tbody><tr><td>1</td><td><span class="z-source z-emacs-lisp"><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-function z-lisp"><span class="z-keyword z-declaration z-function z-lisp">defun</span> <span class="z-entity z-name z-function z-lisp">send-to-haskell</span></span><span class="z-keyword z-operator z-arithmetic z-lisp">/</span><span class="z-symbol z-language z-lisp">hplf-advice</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">orig-fun</span> &amp;<span class="z-support z-function z-lisp">rest</span> <span class="z-symbol z-language z-lisp">args</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>2</td><td>  <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>Wrapper function for `haskell-process-load-file&#39;.<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span>
</td></tr><tr><td>3</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">interactive</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>4</td><td>  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">cond</span>
</td></tr><tr><td>5</td><td>   <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">org-src-mode</span>
</td></tr><tr><td>6</td><td>    <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">send-to-haskell</span><span class="z-keyword z-operator z-arithmetic z-lisp">/</span><span class="z-symbol z-language z-lisp">org-src-block</span> <span class="z-symbol z-language z-lisp">current-prefix-arg</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>7</td><td>   <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">string</span><span class="z-keyword z-operator z-comparison z-lisp">=</span> <span class="z-symbol z-language z-lisp">major-mode</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>org-mode<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>8</td><td>    <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">send-to-haskell</span><span class="z-keyword z-operator z-arithmetic z-lisp">/</span><span class="z-symbol z-language z-lisp">org-src-block</span> <span class="z-symbol z-language z-lisp">current-prefix-arg</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>9</td><td>   <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buffer-file-name</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">apply</span> <span class="z-symbol z-language z-lisp">orig-fun</span> <span class="z-symbol z-language z-lisp">args</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>10</td><td>   <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-constant z-language z-lisp">t</span>
</td></tr><tr><td>11</td><td>    <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">let</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buffer</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">current-buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>12</td><td>          <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">content</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">buffer-string</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>13</td><td>          <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">tmp-file</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">make-temp-file</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>haskell-load-<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-constant z-language z-lisp">nil</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>.hs<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>14</td><td>      <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-keyword z-control z-lisp">with</span><span class="z-symbol z-language z-lisp">-temp-buffer</span>
</td></tr><tr><td>15</td><td>        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">insert</span> <span class="z-symbol z-language z-lisp">content</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>16</td><td>        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">write</span><span class="z-symbol z-language z-lisp">-file</span> <span class="z-symbol z-language z-lisp">tmp-file</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>17</td><td>        <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">send-to-haskell</span><span class="z-keyword z-operator z-arithmetic z-lisp">/</span><span class="z-symbol z-language z-lisp">file-with-buffer</span> <span class="z-symbol z-language z-lisp">tmp-file</span> <span class="z-symbol z-language z-lisp">buffer</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr><tr><td>18</td><td>
</td></tr><tr><td>19</td><td><span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Install the wrapper around `haskell-process-load-file&#39;.
</span></td></tr><tr><td>20</td><td><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">advice-add</span> &#39;<span class="z-symbol z-language z-lisp">haskell-process-load-file</span> :<span class="z-symbol z-language z-lisp">around</span>
</td></tr><tr><td>21</td><td>            <span class="z-constant z-character z-lisp"><span class="z-punctuation z-definition z-constant z-lisp">#</span>&#39;send-to-haskell/hplf-advice</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</td></tr></span></tbody></table></code></pre>
<p>Finally, it's convenient to use the same binding in Org mode buffers as in Haskell buffers (e.g., <strong>M-m m s b</strong> if you're using Spacemacs):</p>
<pre data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><span class="z-source z-emacs-lisp"><span class="z-comment z-line z-semicolon z-lisp"><span class="z-punctuation z-definition z-comment z-lisp">;</span>; Replace the Org mode binding for M-m m s (org-schedule).
</span><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">spacemacs</span><span class="z-keyword z-operator z-arithmetic z-lisp">/</span><span class="z-support z-function z-lisp">set</span><span class="z-symbol z-language z-lisp">-leader-keys-for-major-mode</span> &#39;<span class="z-symbol z-language z-lisp">org-mode</span> <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>s<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> <span class="z-constant z-language z-lisp">nil</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
<span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">spacemacs</span><span class="z-keyword z-operator z-arithmetic z-lisp">/</span><span class="z-support z-function z-lisp">set</span><span class="z-symbol z-language z-lisp">-leader-keys-for-major-mode</span> &#39;<span class="z-symbol z-language z-lisp">org-mode</span>
  <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>sb<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span> &#39;<span class="z-symbol z-language z-lisp">haskell-process-load-file</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</span></code></pre>
<p>And voilà! I can now send Haskell code to a REPL session from within Org documents and from transient code buffers with <strong>M-m m s b</strong>, and I can send individual code blocks from within Org documents with <strong>C-u M-m m s b</strong>.</p>
<h1 id="appendix-additional-configuration">Appendix: Additional configuration</h1>
<p>In the process of coming up with this solution, I also made several other changes to my configuration.</p>
<h2 id="default-extension-for-tangled-files">Default extension for tangled files</h2>
<p>To ensure that the default tangled filename ends with &quot;.hs&quot;, it's a good idea to load Org support for evaluating Haskell source code. This is simple to do in Spacemacs (example shown below) and in <a href="https://orgmode.org/manual/Languages.html">vanilla Emacs</a>.</p>
<pre data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><span class="z-source z-emacs-lisp"><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">spacemacs</span>|<span class="z-support z-function z-lisp">use-package</span><span class="z-symbol z-language z-lisp">-add-hook</span> <span class="z-symbol z-language z-lisp">org</span>
  :<span class="z-symbol z-language z-lisp">post-config</span>
  <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">require</span> &#39;<span class="z-symbol z-language z-lisp">ob-haskell</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</span></code></pre>
<p>Note that this will also enable direct <a href="https://orgmode.org/manual/Evaluating-code-blocks.html">evaluation</a> of Haskell source code blocks in Org documents.</p>
<h2 id="spacemacs-key-bindings-relevant-to-live-coding">Spacemacs key bindings relevant to live coding</h2>
<p>For the purposes of live coding, I also want to switch from my default (dark) theme to a light theme, greatly increase the font size, and quickly switch between code and REPL buffers. So here are some relevant (Spacemacs) bindings:</p>
<ul>
<li><strong>SPC w w:</strong> toggle between open windows
<ul>
<li>Can also use <strong>M-1</strong>, <strong>M-2</strong>, etc.</li>
</ul>
</li>
<li><strong>SPC T n:</strong> cycle colour themes</li>
<li><strong>SPC z x +:</strong> increase font size, enter scaling mode</li>
<li><strong>SPC z x 0:</strong> reset font size, enter scaling mode</li>
<li><strong>SPC m s b:</strong> send active Haskell buffer to REPL</li>
<li><strong>SPC m s s:</strong> show the REPL <em>without</em> activating it</li>
<li><strong>SPC m s S:</strong> show the REPL <em>and</em> activate it</li>
</ul>
<p><em>Reminder to self:</em> in insert mode, use <strong>M-m</strong> instead of <strong>SPC</strong>.</p>
<h2 id="customising-the-repl">Customising the REPL</h2>
<p>By default, Spacemacs would start the REPL buffer in <em>evil mode</em>. But since my primary activity in these buffers is to enter simple expressions for evaluation, I'd rather start the REPL in <em>insert mode</em>:</p>
<pre data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><span class="z-source z-emacs-lisp"><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">add-to-list</span> &#39;<span class="z-symbol z-language z-lisp">evil-insert-state-modes</span>  &#39;<span class="z-symbol z-language z-lisp">haskell-interactive-mode</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</span></code></pre>
<p>I also wanted to silence the several warning messages that appear at the top of every REPL session:</p>
<pre data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><span class="z-source z-emacs-lisp"><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">setq</span> <span class="z-symbol z-language z-lisp">haskell-process-show-debug-tips</span> &#39;<span class="z-constant z-language z-lisp">nil</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</span></code></pre>
<p>You can also ensure that the REPL appears in a <a href="http://haskell.github.io/haskell-mode/manual/latest/Interactive-Haskell.html">separate frame</a>, but I'm not certain whether I want this behaviour.</p>
<h2 id="code-block-indentation">Code block indentation</h2>
<p>I didn't like how code blocks were indented by 2 additional spaces, relative to the <code>#+BEGIN_SRC</code> and <code>#+END_SRC</code> lines. This is <a href="https://emacs.stackexchange.com/a/18892">simple to fix</a>:</p>
<pre data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><span class="z-source z-emacs-lisp"><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">setq</span> <span class="z-symbol z-language z-lisp">org-edit-src-content-indentation</span> <span class="z-constant z-numeric z-lisp">0</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</span></code></pre>
<h2 id="code-folding">Code folding</h2>
<p>Similar to Org mode, you can enable code folding in Haskell buffers by using <a href="https://github.com/alphapapa/outshine">outshine</a>, as described on the Org mode <a href="https://orgmode.org/worg/org-tutorials/org-outside-org.html">wiki</a>.</p>
<pre data-lang="el" class="language-el z-code"><code class="language-el" data-lang="el"><span class="z-source z-emacs-lisp"><span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">add-hook</span> &#39;<span class="z-symbol z-language z-lisp">haskell-mode-hook</span>
          <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">lambda</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
            <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">set</span> <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">make-local-variable</span> &#39;<span class="z-symbol z-language z-lisp">outline-regexp</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
                                      <span class="z-string z-quoted z-double z-lisp"><span class="z-punctuation z-definition z-string z-begin z-lisp">&quot;</span>-- <span class="z-constant z-character z-escape z-lisp">\\</span>*+<span class="z-punctuation z-definition z-string z-end z-lisp">&quot;</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
            <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-support z-function z-lisp">require</span> &#39;<span class="z-symbol z-language z-lisp">outshine</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
            <span class="z-meta z-group z-lisp"><span class="z-punctuation z-definition z-group z-begin z-lisp">(</span><span class="z-symbol z-language z-lisp">outline-minor-mode</span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span><span class="z-punctuation z-definition z-group z-end z-lisp">)</span></span>
</span></code></pre>
<p>Then mark sections, subsections, etc, in a similar manner to Org mode, and use <code>TAB</code> to collapse and expand each section.</p>
<pre data-lang="haskell" class="language-haskell z-code"><code class="language-haskell" data-lang="haskell"><span class="z-source z-haskell"><span class="z-comment z-line z-double-dash z-haskell"><span class="z-punctuation z-definition z-comment z-haskell">--</span> * Section
</span>
f x <span class="z-keyword z-operator z-haskell">=</span> x^<span class="z-constant z-numeric z-integer z-decimal z-haskell">2</span>

<span class="z-comment z-line z-double-dash z-haskell"><span class="z-punctuation z-definition z-comment z-haskell">--</span> ** Subsection
</span>
g x <span class="z-keyword z-operator z-haskell">=</span> x^<span class="z-constant z-numeric z-integer z-decimal z-haskell">3</span>

<span class="z-comment z-line z-double-dash z-haskell"><span class="z-punctuation z-definition z-comment z-haskell">--</span> * Another section
</span>
h x <span class="z-keyword z-operator z-haskell">=</span> (f x) <span class="z-keyword z-operator z-haskell">+</span> (g x)
</span></code></pre>

  </article>
<footer class="site">
    <a href="http://www.ardischeng.com/">icons by ardis</a>&nbsp;/ <a href="https:&#x2F;&#x2F;github.com&#x2F;robmoss&#x2F;robmoss.github.io&#x2F;tree&#x2F;master&#x2F;content/blog&#x2F;2018-02-19-Live-coding-Emacs-and-ghci.md">source</a></footer>
</body>
</html>
